<template>
  <div class="vulnerability-results">
    <!-- ä»»åŠ¡ä¿¡æ¯å¤´éƒ¨ -->
    <div class="task-header">
      <div class="task-info">
        <h1>{{ taskInfo.name }}</h1>
        <div class="task-meta">
          <div class="meta-item">
            <span class="meta-label">ç›®æ ‡URL:</span>
            <span class="meta-value">{{ taskInfo.targetUrl }}</span>
          </div>
          <div class="meta-item">
            <span class="meta-label">å¼€å§‹æ—¶é—´:</span>
            <span class="meta-value">{{ taskInfo.startTime }}</span>
          </div>
          <div class="meta-item">
            <span class="meta-label">çŠ¶æ€:</span>
            <span :class="['status', `status-${taskInfo.status}`]">
              <span class="status-dot"></span>
              {{ getStatusText(taskInfo.status) }}
            </span>
          </div>
        </div>
      </div>
      <div class="task-actions">
        <button @click="exportReport" class="btn btn-outline">
          ğŸ“„ å¯¼å‡ºæŠ¥å‘Š
        </button>
        <button @click="rescanTask" class="btn btn-secondary">
          ğŸ”„ é‡æ–°æ‰«æ
        </button>
      </div>
    </div>

    <!-- æ¼æ´ç»Ÿè®¡ -->
    <div class="vuln-stats">
      <div class="stat-card high-risk">
        <div class="stat-icon">ğŸš¨</div>
        <div class="stat-content">
          <div class="stat-number">{{ vulnStats.high }}</div>
          <div class="stat-label">é«˜å±æ¼æ´</div>
        </div>
      </div>
      <div class="stat-card medium-risk">
        <div class="stat-icon">âš ï¸</div>
        <div class="stat-content">
          <div class="stat-number">{{ vulnStats.medium }}</div>
          <div class="stat-label">ä¸­å±æ¼æ´</div>
        </div>
      </div>
      <div class="stat-card low-risk">
        <div class="stat-icon">â„¹ï¸</div>
        <div class="stat-content">
          <div class="stat-number">{{ vulnStats.low }}</div>
          <div class="stat-label">ä½å±æ¼æ´</div>
        </div>
      </div>
      <div class="stat-card total">
        <div class="stat-icon">ğŸ“Š</div>
        <div class="stat-content">
          <div class="stat-number">{{ vulnStats.total }}</div>
          <div class="stat-label">æ€»è®¡</div>
        </div>
      </div>
    </div>

    <!-- ç­›é€‰å™¨ -->
    <div class="filters-section">
      <div class="card">
        <div class="filters">
          <select v-model="priorityFilter" class="form-select">
            <option value="">å…¨éƒ¨ä¼˜å…ˆçº§</option>
            <option value="high">é«˜å±</option>
            <option value="medium">ä¸­å±</option>
            <option value="low">ä½å±</option>
          </select>
          <select v-model="typeFilter" class="form-select">
            <option value="">å…¨éƒ¨ç±»å‹</option>
            <option value="sql-injection">SQLæ³¨å…¥</option>
            <option value="xss">è·¨ç«™è„šæœ¬</option>
            <option value="csrf">è·¨ç«™è¯·æ±‚ä¼ªé€ </option>
            <option value="file-upload">æ–‡ä»¶ä¸Šä¼ </option>
            <option value="auth-bypass">èº«ä»½éªŒè¯ç»•è¿‡</option>
          </select>
          <select v-model="statusFilter" class="form-select">
            <option value="">å…¨éƒ¨çŠ¶æ€</option>
            <option value="unfixed">æœªä¿®å¤</option>
            <option value="fixed">å·²ä¿®å¤</option>
            <option value="false-positive">è¯¯æŠ¥</option>
          </select>
          <div class="search-box">
            <input 
              v-model="searchQuery" 
              type="text" 
              placeholder="æœç´¢æ¼æ´..." 
              class="form-input"
            >
          </div>
        </div>
      </div>
    </div>

    <!-- æ¼æ´åˆ—è¡¨ -->
    <div class="vulnerabilities-list">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">æ¼æ´è¯¦æƒ… ({{ filteredVulnerabilities.length }})</h3>
          <div class="sort-options">
            <select v-model="sortBy" class="form-select">
              <option value="priority">æŒ‰ä¼˜å…ˆçº§æ’åº</option>
              <option value="type">æŒ‰ç±»å‹æ’åº</option>
              <option value="discovered">æŒ‰å‘ç°æ—¶é—´æ’åº</option>
            </select>
          </div>
        </div>
        
        <div class="vuln-items">
          <div 
            v-for="vuln in filteredVulnerabilities" 
            :key="vuln.id"
            class="vuln-item"
            :class="{ 'high-priority': vuln.priority === 'high' }"
            @click="viewVulnDetail(vuln.id)"
          >
            <div class="vuln-icon">
              <span class="type-icon">{{ getTypeIcon(vuln.type) }}</span>
            </div>
            
            <div class="vuln-content">
              <div class="vuln-header">
                <h4 class="vuln-title">{{ vuln.title }}</h4>
                <div class="vuln-meta">
                  <span class="vuln-type">{{ getTypeText(vuln.type) }}</span>
                  <span class="vuln-location">{{ vuln.location }}</span>
                </div>
              </div>
              
              <div class="vuln-description">
                {{ vuln.description }}
              </div>
              
              <div class="vuln-details">
                <div class="detail-item">
                  <span class="detail-label">CVSSè¯„åˆ†:</span>
                  <span class="detail-value">{{ vuln.cvssScore }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">å½±å“èŒƒå›´:</span>
                  <span class="detail-value">{{ vuln.impact }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">å‘ç°æ—¶é—´:</span>
                  <span class="detail-value">{{ vuln.discoveredAt }}</span>
                </div>
              </div>
            </div>
            
            <div class="vuln-priority">
              <div :class="['priority', `priority-${vuln.priority}`]">
                <div class="priority-stars">
                  <span 
                    v-for="n in 5" 
                    :key="n"
                    class="star"
                    :class="{ 'filled': n <= getPriorityStars(vuln.priority) }"
                  >â˜…</span>
                </div>
                <div class="priority-label">{{ getPriorityText(vuln.priority) }}</div>
              </div>
            </div>
            
            <div class="vuln-actions">
              <div class="action-buttons">
                <button 
                  @click.stop="markAsFixed(vuln.id)"
                  class="btn-icon"
                  title="æ ‡è®°ä¸ºå·²ä¿®å¤"
                  v-if="vuln.status === 'unfixed'"
                >
                  âœ…
                </button>
                <button 
                  @click.stop="markAsFalsePositive(vuln.id)"
                  class="btn-icon"
                  title="æ ‡è®°ä¸ºè¯¯æŠ¥"
                  v-if="vuln.status === 'unfixed'"
                >
                  âŒ
                </button>
                <button 
                  @click.stop="viewVulnDetail(vuln.id)"
                  class="btn-icon"
                  title="æŸ¥çœ‹è¯¦æƒ…"
                >
                  ğŸ‘ï¸
                </button>
              </div>
              
              <div v-if="vuln.status !== 'unfixed'" class="status-badge">
                <span :class="['badge', `badge-${vuln.status}`]">
                  {{ getStatusBadgeText(vuln.status) }}
                </span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- ç©ºçŠ¶æ€ -->
        <div v-if="filteredVulnerabilities.length === 0" class="empty-state">
          <div class="empty-icon">ğŸ”</div>
          <div class="empty-title">æœªæ‰¾åˆ°åŒ¹é…çš„æ¼æ´</div>
          <div class="empty-description">
            å°è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶æˆ–æœç´¢å…³é”®è¯
          </div>
        </div>
      </div>
    </div>

    <!-- AIåˆ†ææ‘˜è¦ -->
    <div class="ai-analysis">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">ğŸ¤– AIåˆ†ææ‘˜è¦</h3>
        </div>
        <div class="analysis-content">
          <div class="analysis-section">
            <h4>é£é™©è¯„ä¼°</h4>
            <p>{{ aiAnalysis.riskAssessment }}</p>
          </div>
          <div class="analysis-section">
            <h4>å…³é”®å‘ç°</h4>
            <ul>
              <li v-for="finding in aiAnalysis.keyFindings" :key="finding">
                {{ finding }}
              </li>
            </ul>
          </div>
          <div class="analysis-section">
            <h4>ä¿®å¤å»ºè®®</h4>
            <p>{{ aiAnalysis.recommendations }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
// TODO: æ›¿æ¢ä¸ºçœŸå®çš„APIè°ƒç”¨
import { 
  mockVulnerabilities, 
  mockAIAnalysis,
  mockScanTasks 
} from '../data/mockData.js'

export default {
  name: 'VulnerabilityResults',
  props: {
    taskId: {
      type: String,
      required: true
    }
  },
  data() {
    return {
      priorityFilter: '',
      typeFilter: '',
      statusFilter: '',
      searchQuery: '',
      sortBy: 'priority',
      
      // TODO: ä»APIè·å–ä»»åŠ¡ä¿¡æ¯ - GET /api/scan-tasks/{taskId}
      taskInfo: mockScanTasks.find(task => task.id == this.taskId) || mockScanTasks[0],
      
      // TODO: ä»APIè·å–æ¼æ´ç»Ÿè®¡ - GET /api/scan-tasks/{taskId}/vulnerability-stats
      vulnStats: {
        high: 3,
        medium: 8,
        low: 12,
        total: 23
      },
      
      // TODO: ä»APIè·å–æ¼æ´åˆ—è¡¨ - GET /api/scan-tasks/{taskId}/vulnerabilities
      vulnerabilities: mockVulnerabilities.filter(vuln => vuln.taskId == this.taskId || this.taskId == '1'),
      
      // TODO: ä»APIè·å–AIåˆ†æç»“æœ - GET /api/scan-tasks/{taskId}/ai-analysis
      aiAnalysis: mockAIAnalysis
    }
  },
  computed: {
    filteredVulnerabilities() {
      let filtered = this.vulnerabilities.filter(vuln => {
        const matchesPriority = !this.priorityFilter || vuln.priority === this.priorityFilter
        const matchesType = !this.typeFilter || vuln.type === this.typeFilter
        const matchesStatus = !this.statusFilter || vuln.status === this.statusFilter
        const matchesSearch = !this.searchQuery || 
          vuln.title.toLowerCase().includes(this.searchQuery.toLowerCase()) ||
          vuln.description.toLowerCase().includes(this.searchQuery.toLowerCase())
        
        return matchesPriority && matchesType && matchesStatus && matchesSearch
      })
      
      // æ’åº
      filtered.sort((a, b) => {
        if (this.sortBy === 'priority') {
          const priorityOrder = { high: 3, medium: 2, low: 1 }
          return priorityOrder[b.priority] - priorityOrder[a.priority]
        } else if (this.sortBy === 'type') {
          return a.type.localeCompare(b.type)
        } else if (this.sortBy === 'discovered') {
          return new Date(b.discoveredAt) - new Date(a.discoveredAt)
        }
        return 0
      })
      
      return filtered
    }
  },
  methods: {
    getStatusText(status) {
      const statusMap = {
        waiting: 'ç­‰å¾…ä¸­',
        running: 'è¿›è¡Œä¸­',
        completed: 'å·²å®Œæˆ',
        failed: 'å¤±è´¥'
      }
      return statusMap[status] || status
    },
    getTypeIcon(type) {
      const iconMap = {
        'sql-injection': 'ğŸ—„ï¸',
        'xss': 'ğŸ”—',
        'csrf': 'ğŸ”„',
        'file-upload': 'ğŸ“',
        'auth-bypass': 'ğŸ”'
      }
      return iconMap[type] || 'âš ï¸'
    },
    getTypeText(type) {
      const typeMap = {
        'sql-injection': 'SQLæ³¨å…¥',
        'xss': 'è·¨ç«™è„šæœ¬',
        'csrf': 'è·¨ç«™è¯·æ±‚ä¼ªé€ ',
        'file-upload': 'æ–‡ä»¶ä¸Šä¼ ',
        'auth-bypass': 'èº«ä»½éªŒè¯ç»•è¿‡'
      }
      return typeMap[type] || type
    },
    getPriorityText(priority) {
      const priorityMap = {
        low: 'ä½å±',
        medium: 'ä¸­å±',
        high: 'é«˜å±'
      }
      return priorityMap[priority] || priority
    },
    getPriorityStars(priority) {
      const starMap = {
        low: 1,
        medium: 3,
        high: 5
      }
      return starMap[priority] || 1
    },
    getStatusBadgeText(status) {
      const statusMap = {
        fixed: 'å·²ä¿®å¤',
        'false-positive': 'è¯¯æŠ¥'
      }
      return statusMap[status] || status
    },
    viewVulnDetail(vulnId) {
      this.$router.push(`/vulnerability/${vulnId}`)
    },
    markAsFixed(vulnId) {
      const vuln = this.vulnerabilities.find(v => v.id === vulnId)
      if (vuln) {
        vuln.status = 'fixed'
        this.updateStats()
      }
    },
    markAsFalsePositive(vulnId) {
      const vuln = this.vulnerabilities.find(v => v.id === vulnId)
      if (vuln) {
        vuln.status = 'false-positive'
        this.updateStats()
      }
    },
    updateStats() {
      const unfixedVulns = this.vulnerabilities.filter(v => v.status === 'unfixed')
      this.vulnStats = {
        high: unfixedVulns.filter(v => v.priority === 'high').length,
        medium: unfixedVulns.filter(v => v.priority === 'medium').length,
        low: unfixedVulns.filter(v => v.priority === 'low').length,
        total: unfixedVulns.length
      }
    },
    exportReport() {
      // å®ç°å¯¼å‡ºæŠ¥å‘ŠåŠŸèƒ½
      console.log('å¯¼å‡ºæŠ¥å‘Š')
    },
    rescanTask() {
      // å®ç°é‡æ–°æ‰«æåŠŸèƒ½
      console.log('é‡æ–°æ‰«æ')
    }
  },
  mounted() {
    // æ ¹æ®taskIdåŠ è½½æ•°æ®
    console.log('åŠ è½½ä»»åŠ¡æ•°æ®:', this.taskId)
  }
}
</script>

<style scoped>
.vulnerability-results {
  max-width: 1400px;
  margin: 0 auto;
}

/* ä»»åŠ¡ä¿¡æ¯å¤´éƒ¨ */
.task-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: var(--spacing-xl);
  padding: var(--spacing-lg);
  background-color: var(--card-background);
  border-radius: var(--border-radius);
  box-shadow: var(--shadow-sm);
}

.task-info h1 {
  margin-bottom: var(--spacing-md);
}

.task-meta {
  display: flex;
  flex-wrap: wrap;
  gap: var(--spacing-lg);
}

.meta-item {
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
}

.meta-label {
  color: var(--text-secondary);
  font-weight: bold;
}

.meta-value {
  color: var(--text-primary);
}

.task-actions {
  display: flex;
  gap: var(--spacing-md);
}

/* æ¼æ´ç»Ÿè®¡ */
.vuln-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: var(--spacing-md);
  margin-bottom: var(--spacing-xl);
}

.stat-card {
  background-color: var(--card-background);
  border-radius: var(--border-radius);
  padding: var(--spacing-lg);
  box-shadow: var(--shadow-sm);
  display: flex;
  align-items: center;
  gap: var(--spacing-md);
  border-left: 4px solid transparent;
}

.stat-card.high-risk {
  border-left-color: var(--high-risk);
}

.stat-card.medium-risk {
  border-left-color: var(--medium-risk);
}

.stat-card.low-risk {
  border-left-color: var(--low-risk);
}

.stat-card.total {
  border-left-color: var(--primary-color);
}

.stat-icon {
  font-size: 28px;
}

.stat-number {
  font-size: 24px;
  font-weight: bold;
  color: var(--text-primary);
}

.stat-label {
  color: var(--text-secondary);
  font-size: 14px;
}

/* ç­›é€‰å™¨ */
.filters-section {
  margin-bottom: var(--spacing-lg);
}

.filters {
  display: flex;
  gap: var(--spacing-md);
  align-items: center;
}

.search-box {
  flex: 1;
  max-width: 300px;
}

/* æ¼æ´åˆ—è¡¨ */
.vuln-items {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-md);
}

.vuln-item {
  display: flex;
  align-items: flex-start;
  gap: var(--spacing-md);
  padding: var(--spacing-lg);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  cursor: pointer;
  transition: all 0.2s ease;
}

.vuln-item:hover {
  background-color: var(--background-color);
  border-color: var(--secondary-color);
  box-shadow: var(--shadow-sm);
}

.vuln-item.high-priority {
  border-left: 4px solid var(--high-risk);
  background-color: rgba(231, 76, 60, 0.02);
}

.vuln-icon {
  flex-shrink: 0;
}

.type-icon {
  font-size: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  background-color: var(--background-color);
  border-radius: var(--border-radius);
}

.vuln-content {
  flex: 1;
}

.vuln-header {
  margin-bottom: var(--spacing-sm);
}

.vuln-title {
  font-size: 16px;
  font-weight: bold;
  color: var(--text-primary);
  margin-bottom: var(--spacing-xs);
}

.vuln-meta {
  display: flex;
  gap: var(--spacing-md);
  font-size: 12px;
  color: var(--text-secondary);
}

.vuln-type {
  background-color: var(--secondary-color);
  color: white;
  padding: 2px var(--spacing-xs);
  border-radius: 10px;
  font-weight: bold;
}

.vuln-description {
  color: var(--text-secondary);
  margin-bottom: var(--spacing-md);
  line-height: 1.5;
}

.vuln-details {
  display: flex;
  flex-wrap: wrap;
  gap: var(--spacing-lg);
}

.detail-item {
  display: flex;
  gap: var(--spacing-xs);
  font-size: 12px;
}

.detail-label {
  color: var(--text-secondary);
  font-weight: bold;
}

.detail-value {
  color: var(--text-primary);
}

.vuln-priority {
  flex-shrink: 0;
  text-align: center;
}

.priority-stars {
  display: flex;
  gap: 1px;
  margin-bottom: var(--spacing-xs);
}

.star {
  font-size: 14px;
  color: #ddd;
}

.star.filled {
  color: currentColor;
}

.priority-label {
  font-size: 11px;
  font-weight: bold;
}

.vuln-actions {
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--spacing-sm);
}

.action-buttons {
  display: flex;
  gap: var(--spacing-xs);
}

.btn-icon {
  background: none;
  border: none;
  cursor: pointer;
  padding: var(--spacing-xs);
  border-radius: var(--border-radius);
  font-size: 16px;
  transition: background-color 0.2s ease;
}

.btn-icon:hover {
  background-color: var(--background-color);
}

.status-badge {
  text-align: center;
}

.badge {
  padding: 2px var(--spacing-xs);
  border-radius: 10px;
  font-size: 10px;
  font-weight: bold;
}

.badge-fixed {
  background-color: rgba(46, 204, 113, 0.1);
  color: var(--success-color);
}

.badge-false-positive {
  background-color: rgba(149, 165, 166, 0.1);
  color: var(--text-secondary);
}

/* ç©ºçŠ¶æ€ */
.empty-state {
  text-align: center;
  padding: var(--spacing-xl);
  color: var(--text-secondary);
}

.empty-icon {
  font-size: 48px;
  margin-bottom: var(--spacing-md);
}

.empty-title {
  font-size: 18px;
  font-weight: bold;
  margin-bottom: var(--spacing-sm);
}

.empty-description {
  font-size: 14px;
}

/* AIåˆ†æ */
.ai-analysis {
  margin-top: var(--spacing-xl);
}

.analysis-content {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: var(--spacing-lg);
}

.analysis-section h4 {
  color: var(--primary-color);
  margin-bottom: var(--spacing-sm);
  font-size: 14px;
}

.analysis-section p {
  color: var(--text-secondary);
  line-height: 1.5;
  margin-bottom: var(--spacing-md);
}

.analysis-section ul {
  color: var(--text-secondary);
  padding-left: var(--spacing-md);
}

.analysis-section li {
  margin-bottom: var(--spacing-xs);
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .task-header {
    flex-direction: column;
    gap: var(--spacing-md);
  }
  
  .task-meta {
    flex-direction: column;
    align-items: flex-start;
    gap: var(--spacing-sm);
  }
  
  .filters {
    flex-direction: column;
    align-items: stretch;
  }
  
  .search-box {
    max-width: none;
  }
  
  .vuln-item {
    flex-direction: column;
    gap: var(--spacing-sm);
  }
  
  .vuln-details {
    flex-direction: column;
    gap: var(--spacing-sm);
  }
  
  .analysis-content {
    grid-template-columns: 1fr;
  }
}
</style>
