<template>
  <div class="vulnerability-detail">
    <!-- è¿”å›æŒ‰é’® -->
    <div class="back-nav">
      <button @click="goBack" class="btn btn-outline">
        â† è¿”å›æ¼æ´åˆ—è¡¨
      </button>
    </div>

    <!-- æ¼æ´åŸºæœ¬ä¿¡æ¯ -->
    <div class="vuln-header">
      <div class="header-content">
        <div class="vuln-title-section">
          <h1 :class="['vuln-title', `priority-${vulnerability.priority}`]">
            {{ vulnerability.title }}
          </h1>
          <div class="vuln-meta">
            <span class="vuln-type">{{ getTypeText(vulnerability.type) }}</span>
            <span class="vuln-location">{{ vulnerability.location }}</span>
          </div>
        </div>
        <div class="vuln-priority-section">
          <div :class="['priority-display', `priority-${vulnerability.priority}`]">
            <div class="priority-stars">
              <span 
                v-for="n in 5" 
                :key="n"
                class="star"
                :class="{ 'filled': n <= getPriorityStars(vulnerability.priority) }"
              >â˜…</span>
            </div>
            <div class="priority-label">{{ getPriorityText(vulnerability.priority) }}</div>
          </div>
        </div>
      </div>
    </div>

    <div class="detail-content">
      <!-- å·¦ä¾§ä¿¡æ¯åŒº -->
      <div class="left-panel">
        <!-- åŸºæœ¬ä¿¡æ¯å¡ç‰‡ -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">åŸºæœ¬ä¿¡æ¯</h3>
          </div>
          <div class="info-grid">
            <div class="info-item">
              <div class="info-label">æ¼æ´ç±»å‹</div>
              <div class="info-value">
                <span class="type-icon">{{ getTypeIcon(vulnerability.type) }}</span>
                {{ getTypeText(vulnerability.type) }}
              </div>
            </div>
            <div class="info-item">
              <div class="info-label">CVSSè¯„åˆ†</div>
              <div class="info-value cvss-score">
                {{ vulnerability.cvssScore }}
                <div class="score-stars">
                  <span 
                    v-for="n in 10" 
                    :key="n"
                    class="score-star"
                    :class="{ 'filled': n <= Math.floor(vulnerability.cvssScore) }"
                  >â˜…</span>
                </div>
              </div>
            </div>
            <div class="info-item">
              <div class="info-label">å½±å“èŒƒå›´</div>
              <div class="info-value">{{ vulnerability.impact }}</div>
            </div>
            <div class="info-item">
              <div class="info-label">å‘ç°ä½ç½®</div>
              <div class="info-value code-location">{{ vulnerability.location }}</div>
            </div>
            <div class="info-item">
              <div class="info-label">å‘ç°æ—¶é—´</div>
              <div class="info-value">{{ vulnerability.discoveredAt }}</div>
            </div>
          </div>
        </div>

        <!-- æ¼æ´æè¿° -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">æ¼æ´æè¿°</h3>
          </div>
          <div class="description-content">
            <p>{{ vulnerability.description }}</p>
            <div v-if="vulnerability.technicalDetails" class="technical-details">
              <h4>æŠ€æœ¯ç»†èŠ‚</h4>
              <p>{{ vulnerability.technicalDetails }}</p>
            </div>
          </div>
        </div>

        <!-- æ¼æ´ç¤ºä¾‹ -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">æ¼æ´ç¤ºä¾‹</h3>
            <button @click="showExample = !showExample" class="btn btn-outline">
              {{ showExample ? 'æ”¶èµ·' : 'å±•å¼€' }}
            </button>
          </div>
          <div v-if="showExample" class="example-content">
            <div class="example-section">
              <h4>æ¶æ„è½½è·</h4>
              <div class="code-block">
                <pre><code>{{ vulnerability.payload }}</code></pre>
              </div>
            </div>
            <div class="example-section">
              <h4>å“åº”ç¤ºä¾‹</h4>
              <div class="code-block">
                <pre><code>{{ vulnerability.response }}</code></pre>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- å³ä¾§AIåˆ†æåŒº -->
      <div class="right-panel">
        <!-- AIåˆ†æ -->
        <div class="card ai-analysis-card">
          <div class="card-header">
            <h3 class="card-title">ğŸ¤– AIåˆ†æ</h3>
          </div>
          <div class="ai-content">
            <div class="analysis-section">
              <h4>ä¼˜å…ˆçº§ç†ç”±</h4>
              <p>{{ aiAnalysis.priorityReason }}</p>
            </div>
            <div class="analysis-section">
              <h4>é£é™©å…³è”åˆ†æ</h4>
              <p>{{ aiAnalysis.riskCorrelation }}</p>
            </div>
            <div class="analysis-section">
              <h4>è¯¯æŠ¥åˆ¤æ–­</h4>
              <div class="false-positive-analysis">
                <span :class="['fp-status', aiAnalysis.falsePositive ? 'fp-yes' : 'fp-no']">
                  {{ aiAnalysis.falsePositive ? 'å¯èƒ½è¯¯æŠ¥' : 'éè¯¯æŠ¥' }}
                </span>
                <p>{{ aiAnalysis.fpReason }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- ä¿®å¤å»ºè®® -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">ä¿®å¤å»ºè®®</h3>
          </div>
          <div class="fix-suggestions">
            <div v-for="(step, index) in fixSteps" :key="index" class="fix-step">
              <div class="step-number">{{ index + 1 }}</div>
              <div class="step-content">
                <h4>{{ step.title }}</h4>
                <p>{{ step.description }}</p>
                <div v-if="step.code" class="code-example">
                  <pre><code>{{ step.code }}</code></pre>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="action-panel">
          <button 
            @click="markAsFixed" 
            class="btn btn-success w-100"
            v-if="vulnerability.status === 'unfixed'"
          >
            âœ… æ ‡è®°ä¸ºå·²ä¿®å¤
          </button>
          <button 
            @click="markAsFalsePositive" 
            class="btn btn-outline w-100"
            v-if="vulnerability.status === 'unfixed'"
          >
            âŒ æ ‡è®°ä¸ºè¯¯æŠ¥
          </button>
          <div v-if="vulnerability.status !== 'unfixed'" class="status-display">
            <span :class="['status-badge', `status-${vulnerability.status}`]">
              {{ getStatusText(vulnerability.status) }}
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
// TODO: æ›¿æ¢ä¸ºçœŸå®çš„APIè°ƒç”¨
import { 
  mockVulnerabilities, 
  mockAIAnalysis, 
  mockFixSteps 
} from '../data/mockData.js'

export default {
  name: 'VulnerabilityDetail',
  props: {
    id: {
      type: String,
      required: true
    }
  },
  data() {
    return {
      showExample: false,
      
      // TODO: ä»APIè·å–æ¼æ´è¯¦æƒ… - GET /api/vulnerabilities/{id}
      vulnerability: mockVulnerabilities.find(vuln => vuln.id == this.id) || mockVulnerabilities[0],
      
      // TODO: ä»APIè·å–AIåˆ†æ - GET /api/vulnerabilities/{id}/ai-analysis
      aiAnalysis: mockAIAnalysis,
      
      // TODO: ä»APIè·å–ä¿®å¤æ­¥éª¤ - GET /api/vulnerabilities/{id}/fix-steps
      fixSteps: mockFixSteps
    }
  },
  methods: {
    goBack() {
      this.$router.go(-1)
    },
    getTypeIcon(type) {
      const iconMap = {
        'sql-injection': 'ğŸ—„ï¸',
        'xss': 'ğŸ”—',
        'csrf': 'ğŸ”„',
        'file-upload': 'ğŸ“',
        'auth-bypass': 'ğŸ”'
      }
      return iconMap[type] || 'âš ï¸'
    },
    getTypeText(type) {
      const typeMap = {
        'sql-injection': 'SQLæ³¨å…¥',
        'xss': 'è·¨ç«™è„šæœ¬',
        'csrf': 'è·¨ç«™è¯·æ±‚ä¼ªé€ ',
        'file-upload': 'æ–‡ä»¶ä¸Šä¼ ',
        'auth-bypass': 'èº«ä»½éªŒè¯ç»•è¿‡'
      }
      return typeMap[type] || type
    },
    getPriorityText(priority) {
      const priorityMap = {
        low: 'ä½å±',
        medium: 'ä¸­å±',
        high: 'é«˜å±'
      }
      return priorityMap[priority] || priority
    },
    getPriorityStars(priority) {
      const starMap = {
        low: 1,
        medium: 3,
        high: 5
      }
      return starMap[priority] || 1
    },
    getStatusText(status) {
      const statusMap = {
        fixed: 'å·²ä¿®å¤',
        'false-positive': 'è¯¯æŠ¥'
      }
      return statusMap[status] || status
    },
    markAsFixed() {
      this.vulnerability.status = 'fixed'
      // è¿™é‡Œå¯ä»¥è°ƒç”¨APIæ›´æ–°çŠ¶æ€
    },
    markAsFalsePositive() {
      this.vulnerability.status = 'false-positive'
      // è¿™é‡Œå¯ä»¥è°ƒç”¨APIæ›´æ–°çŠ¶æ€
    }
  },
  mounted() {
    // æ ¹æ®IDåŠ è½½æ¼æ´è¯¦æƒ…
    console.log('åŠ è½½æ¼æ´è¯¦æƒ…:', this.id)
  }
}
</script>

<style scoped>
.vulnerability-detail {
  max-width: 1400px;
  margin: 0 auto;
}

.back-nav {
  margin-bottom: var(--spacing-lg);
}

/* æ¼æ´å¤´éƒ¨ */
.vuln-header {
  background-color: var(--card-background);
  border-radius: var(--border-radius);
  padding: var(--spacing-xl);
  margin-bottom: var(--spacing-xl);
  box-shadow: var(--shadow-sm);
}

.header-content {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
}

.vuln-title {
  font-size: 28px;
  font-weight: bold;
  margin-bottom: var(--spacing-md);
}

.vuln-title.priority-high {
  color: var(--high-risk);
}

.vuln-title.priority-medium {
  color: var(--medium-risk);
}

.vuln-title.priority-low {
  color: var(--low-risk);
}

.vuln-meta {
  display: flex;
  gap: var(--spacing-md);
}

.vuln-type {
  background-color: var(--secondary-color);
  color: white;
  padding: var(--spacing-xs) var(--spacing-sm);
  border-radius: var(--border-radius);
  font-size: 12px;
  font-weight: bold;
}

.vuln-location {
  font-family: monospace;
  background-color: var(--background-color);
  padding: var(--spacing-xs) var(--spacing-sm);
  border-radius: var(--border-radius);
  font-size: 12px;
}

.priority-display {
  text-align: center;
}

.priority-stars {
  display: flex;
  gap: 2px;
  margin-bottom: var(--spacing-xs);
}

.star {
  font-size: 20px;
  color: #ddd;
}

.star.filled {
  color: currentColor;
}

.priority-label {
  font-size: 14px;
  font-weight: bold;
}

/* è¯¦æƒ…å†…å®¹å¸ƒå±€ */
.detail-content {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: var(--spacing-xl);
}

/* ä¿¡æ¯ç½‘æ ¼ */
.info-grid {
  display: grid;
  gap: var(--spacing-md);
}

.info-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: var(--spacing-sm) 0;
  border-bottom: 1px solid var(--border-color);
}

.info-label {
  font-weight: bold;
  color: var(--text-secondary);
}

.info-value {
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
}

.cvss-score {
  flex-direction: column;
  align-items: flex-end;
}

.score-stars {
  display: flex;
  gap: 1px;
}

.score-star {
  font-size: 10px;
  color: #ddd;
}

.score-star.filled {
  color: var(--high-risk);
}

.code-location {
  font-family: monospace;
  background-color: var(--background-color);
  padding: 2px var(--spacing-xs);
  border-radius: 3px;
}

/* æè¿°å†…å®¹ */
.description-content p {
  line-height: 1.6;
  margin-bottom: var(--spacing-md);
}

.technical-details h4 {
  color: var(--primary-color);
  margin-bottom: var(--spacing-sm);
}

/* ä»£ç å— */
.code-block {
  background-color: #f8f9fa;
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  padding: var(--spacing-md);
  margin: var(--spacing-sm) 0;
}

.code-block pre {
  margin: 0;
  font-family: 'Courier New', monospace;
  font-size: 12px;
  line-height: 1.4;
  overflow-x: auto;
}

/* AIåˆ†æå¡ç‰‡ */
.ai-analysis-card {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-left: 4px solid var(--secondary-color);
}

.analysis-section {
  margin-bottom: var(--spacing-lg);
}

.analysis-section h4 {
  color: var(--primary-color);
  font-size: 14px;
  margin-bottom: var(--spacing-sm);
}

.analysis-section p {
  color: var(--text-secondary);
  line-height: 1.5;
  font-size: 13px;
}

.false-positive-analysis {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-xs);
}

.fp-status {
  padding: var(--spacing-xs) var(--spacing-sm);
  border-radius: var(--border-radius);
  font-size: 12px;
  font-weight: bold;
  align-self: flex-start;
}

.fp-status.fp-yes {
  background-color: rgba(245, 166, 35, 0.1);
  color: var(--medium-risk);
}

.fp-status.fp-no {
  background-color: rgba(46, 204, 113, 0.1);
  color: var(--success-color);
}

/* ä¿®å¤å»ºè®® */
.fix-suggestions {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-lg);
}

.fix-step {
  display: flex;
  gap: var(--spacing-md);
}

.step-number {
  flex-shrink: 0;
  width: 24px;
  height: 24px;
  background-color: var(--primary-color);
  color: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: bold;
}

.step-content h4 {
  color: var(--text-primary);
  font-size: 14px;
  margin-bottom: var(--spacing-xs);
}

.step-content p {
  color: var(--text-secondary);
  line-height: 1.5;
  margin-bottom: var(--spacing-sm);
}

.code-example {
  background-color: #f8f9fa;
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  padding: var(--spacing-sm);
}

.code-example pre {
  margin: 0;
  font-family: 'Courier New', monospace;
  font-size: 11px;
  line-height: 1.4;
  overflow-x: auto;
}

/* æ“ä½œé¢æ¿ */
.action-panel {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-md);
}

.status-display {
  text-align: center;
  padding: var(--spacing-md);
}

.status-badge {
  padding: var(--spacing-sm) var(--spacing-md);
  border-radius: var(--border-radius);
  font-weight: bold;
}

.status-badge.status-fixed {
  background-color: rgba(46, 204, 113, 0.1);
  color: var(--success-color);
}

.status-badge.status-false-positive {
  background-color: rgba(149, 165, 166, 0.1);
  color: var(--text-secondary);
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .detail-content {
    grid-template-columns: 1fr;
  }
  
  .header-content {
    flex-direction: column;
    gap: var(--spacing-md);
  }
  
  .vuln-title {
    font-size: 20px;
  }
  
  .info-item {
    flex-direction: column;
    align-items: flex-start;
    gap: var(--spacing-xs);
  }
  
  .fix-step {
    flex-direction: column;
  }
}
</style>
